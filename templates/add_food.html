{% extends "base.html" %}

{% block content %}
<div class="card">
    <h2>Add Food Entry</h2>
    
    {% if error %}
    <div style="background: #ff6b6b; color: white; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
        {{ error }}
    </div>
    {% endif %}
    
    <form method="POST">
        <div class="form-group">
            <label for="food_name">Food Name</label>
            <div style="position: relative;">
                <input type="text" id="food_name" name="food_name" required 
                       placeholder="Search for food or enter custom name"
                       value="{{ selected_food.name if selected_food else '' }}">
                <div id="search-results" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-top: none; max-height: 200px; overflow-y: auto; z-index: 1000; display: none;"></div>
            </div>
        </div>
        
        <div class="form-group">
            <label for="calories_per_100g">Calories per 100g</label>
            <input type="number" id="calories_per_100g" name="calories_per_100g" required min="0" step="0.1"
                   value="{{ selected_food.calories_per_100g if selected_food else '' }}">
        </div>
        
        <div class="form-group">
            <label for="quantity">Quantity (grams)</label>
            <input type="number" id="quantity" name="quantity" required min="0" step="0.1">
        </div>
        
        <div class="form-group">
            <label for="meal_type">Meal Type</label>
            <select id="meal_type" name="meal_type" required>
                <option value="">Select Meal Type</option>
                <option value="breakfast">Breakfast</option>
                <option value="lunch">Lunch</option>
                <option value="dinner">Dinner</option>
                <option value="snack">Snack</option>
            </select>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
                <label for="date">Date (optional)</label>
                <input type="date" id="date" name="date">
            </div>
            
            <div class="form-group">
                <label for="time">Time (optional)</label>
                <input type="time" id="time" name="time">
            </div>
        </div>
        
        <div style="display: flex; gap: 1rem; margin-top: 2rem;">
            <button type="submit" class="btn btn-primary" style="flex: 1;">Add Food Entry</button>
            <a href="{{ url_for('main.food_tracker_page') }}" class="btn btn-secondary">View Tracker</a>
        </div>
    </form>
</div>

<script>
// Food search functionality
const foodNameInput = document.getElementById('food_name');
const caloriesInput = document.getElementById('calories_per_100g');
const searchResults = document.getElementById('search-results');

foodNameInput.addEventListener('input', function() {
    const query = this.value.trim();
    if (query.length < 2) {
        searchResults.style.display = 'none';
        return;
    }
    
    fetch(`{{ url_for('main.search_food') }}?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(foods => {
            if (foods.length > 0) {
                searchResults.innerHTML = foods.map(food => 
                    `<div class="search-result" onclick="selectFood('${food.name}', ${food.calories_per_100g})" 
                          style="padding: 0.75rem; cursor: pointer; border-bottom: 1px solid #eee;">
                        <strong>${food.name}</strong> - ${food.calories_per_100g} cal/100g
                     </div>`
                ).join('');
                searchResults.style.display = 'block';
            } else {
                searchResults.style.display = 'none';
            }
        });
});

function selectFood(name, calories) {
    foodNameInput.value = name;
    caloriesInput.value = calories;
    searchResults.style.display = 'none';
}

// Hide search results when clicking outside
document.addEventListener('click', function(e) {
    if (!foodNameInput.contains(e.target) && !searchResults.contains(e.target)) {
        searchResults.style.display = 'none';
    }
});
</script>
{% endblock %}
